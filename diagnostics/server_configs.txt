Generated on 2025-08-08 14:33:26 by root

[32m[INFO] === SERVER CONFIGS ===(B[m

# --- dpkg (net) ---
ii  iptables                        1.8.10-3ubuntu2                             amd64        administration tools for packet filtering and NAT
rc  iptables-persistent             1.0.20                                      all          boot-time loader for netfilter rules, iptables plugin
ii  net-tools                       2.10-0.1ubuntu4.4                           amd64        NET-3 networking toolkit
ii  stunnel4                        3:5.72-1build2                              amd64        Universal SSL tunnel for network daemons

# --- nft list ruleset ---
table ip filter {
	chain ufw-before-logging-input {
	}

	chain ufw-before-logging-output {
	}

	chain ufw-before-logging-forward {
	}

	chain ufw-before-input {
		iifname "lo" counter packets 354706 bytes 69974562 accept
		ct state related,established counter packets 315404 bytes 279580834 accept
		ct state invalid counter packets 352 bytes 128987 jump ufw-logging-deny
		ct state invalid counter packets 352 bytes 128987 drop
		ip protocol icmp icmp type destination-unreachable counter packets 0 bytes 0 accept
		ip protocol icmp icmp type time-exceeded counter packets 0 bytes 0 accept
		ip protocol icmp icmp type parameter-problem counter packets 0 bytes 0 accept
		ip protocol icmp icmp type echo-request counter packets 8778 bytes 593018 accept
		udp sport 67 udp dport 68 counter packets 0 bytes 0 accept
		counter packets 22704 bytes 2384047 jump ufw-not-local
		ip daddr 224.0.0.251 udp dport 5353 counter packets 0 bytes 0 accept
		ip daddr 239.255.255.250 udp dport 1900 counter packets 0 bytes 0 accept
		counter packets 22704 bytes 2384047 jump ufw-user-input
	}

	chain ufw-before-output {
		oifname "lo" counter packets 354706 bytes 69974562 accept
		ct state related,established counter packets 313663 bytes 96476914 accept
		counter packets 4523 bytes 390077 jump ufw-user-output
	}

	chain ufw-before-forward {
		ct state related,established counter packets 0 bytes 0 accept
		ip protocol icmp icmp type destination-unreachable counter packets 0 bytes 0 accept
		ip protocol icmp icmp type time-exceeded counter packets 0 bytes 0 accept
		ip protocol icmp icmp type parameter-problem counter packets 0 bytes 0 accept
		ip protocol icmp icmp type echo-request counter packets 0 bytes 0 accept
		counter packets 0 bytes 0 jump ufw-user-forward
	}

	chain ufw-after-input {
		udp dport 137 counter packets 6 bytes 468 jump ufw-skip-to-policy-input
		udp dport 138 counter packets 0 bytes 0 jump ufw-skip-to-policy-input
		tcp dport 139 counter packets 26 bytes 1320 jump ufw-skip-to-policy-input
		tcp dport 445 counter packets 80 bytes 3932 jump ufw-skip-to-policy-input
		udp dport 67 counter packets 0 bytes 0 jump ufw-skip-to-policy-input
		udp dport 68 counter packets 0 bytes 0 jump ufw-skip-to-policy-input
		fib daddr type broadcast counter packets 0 bytes 0 jump ufw-skip-to-policy-input
	}

	chain ufw-after-output {
	}

	chain ufw-after-forward {
	}

	chain ufw-after-logging-input {
		limit rate 3/minute burst 10 packets counter packets 859 bytes 134155 log prefix "[UFW BLOCK] "
	}

	chain ufw-after-logging-output {
	}

	chain ufw-after-logging-forward {
		limit rate 3/minute burst 10 packets counter packets 0 bytes 0 log prefix "[UFW BLOCK] "
	}

	chain ufw-reject-input {
	}

	chain ufw-reject-output {
	}

	chain ufw-reject-forward {
	}

	chain ufw-track-input {
	}

	chain ufw-track-output {
		ip protocol tcp ct state new counter packets 1092 bytes 65520 accept
		ip protocol udp ct state new counter packets 3313 bytes 316821 accept
	}

	chain ufw-track-forward {
	}

	chain INPUT {
		type filter hook input priority filter; policy drop;
		counter packets 701944 bytes 352661448 jump ufw-before-logging-input
		counter packets 701944 bytes 352661448 jump ufw-before-input
		counter packets 13609 bytes 1843654 jump ufw-after-input
		counter packets 13497 bytes 1837934 jump ufw-after-logging-input
		counter packets 13497 bytes 1837934 jump ufw-reject-input
		counter packets 13497 bytes 1837934 jump ufw-track-input
	}

	chain OUTPUT {
		type filter hook output priority filter; policy accept;
		counter packets 672892 bytes 166841553 jump ufw-before-logging-output
		counter packets 672892 bytes 166841553 jump ufw-before-output
		counter packets 4523 bytes 390077 jump ufw-after-output
		counter packets 4523 bytes 390077 jump ufw-after-logging-output
		counter packets 4523 bytes 390077 jump ufw-reject-output
		counter packets 4523 bytes 390077 jump ufw-track-output
	}

	chain FORWARD {
		type filter hook forward priority filter; policy drop;
		counter packets 0 bytes 0 jump ufw-before-logging-forward
		counter packets 0 bytes 0 jump ufw-before-forward
		counter packets 0 bytes 0 jump ufw-after-forward
		counter packets 0 bytes 0 jump ufw-after-logging-forward
		counter packets 0 bytes 0 jump ufw-reject-forward
		counter packets 0 bytes 0 jump ufw-track-forward
	}

	chain ufw-logging-deny {
		ct state invalid limit rate 3/minute burst 10 packets counter packets 85 bytes 35148 return
		limit rate 3/minute burst 10 packets counter packets 12 bytes 7416 log prefix "[UFW BLOCK] "
	}

	chain ufw-logging-allow {
		limit rate 3/minute burst 10 packets counter packets 0 bytes 0 log prefix "[UFW ALLOW] "
	}

	chain ufw-skip-to-policy-input {
		counter packets 112 bytes 5720 drop
	}

	chain ufw-skip-to-policy-output {
		counter packets 0 bytes 0 accept
	}

	chain ufw-skip-to-policy-forward {
		counter packets 0 bytes 0 drop
	}

	chain ufw-not-local {
		fib daddr type local counter packets 22701 bytes 2383887 return
		fib daddr type multicast counter packets 3 bytes 160 return
		fib daddr type broadcast counter packets 0 bytes 0 return
		limit rate 3/minute burst 10 packets counter packets 0 bytes 0 jump ufw-logging-deny
		counter packets 0 bytes 0 drop
	}

	chain ufw-user-input {
		tcp dport 443 counter packets 195 bytes 11200 accept
		tcp dport 5000 counter packets 32 bytes 1880 accept
		tcp dport 22 counter packets 1825 bytes 107177 accept
		tcp dport 22  counter packets 0 bytes 0 accept
		udp dport 5000 counter packets 0 bytes 0 accept
		ip protocol udp udp dport { 500, 4500 } counter packets 10 bytes 4201 accept
		tcp dport 3000 counter packets 75 bytes 4036 accept
	}

	chain ufw-user-output {
	}

	chain ufw-user-forward {
	}

	chain ufw-user-logging-input {
	}

	chain ufw-user-logging-output {
	}

	chain ufw-user-logging-forward {
	}

	chain ufw-user-limit {
		limit rate 3/minute burst 5 packets counter packets 0 bytes 0 log prefix "[UFW LIMIT BLOCK] "
		counter packets 0 bytes 0 reject
	}

	chain ufw-user-limit-accept {
		counter packets 0 bytes 0 accept
	}
}
table ip6 filter {
	chain ufw6-before-logging-input {
	}

	chain ufw6-before-logging-output {
	}

	chain ufw6-before-logging-forward {
	}

	chain ufw6-before-input {
		iifname "lo" counter packets 19854 bytes 29249559 accept
		rt type 0 counter packets 0 bytes 0 drop
		ct state related,established counter packets 36101 bytes 546698888 accept
		meta l4proto ipv6-icmp icmpv6 type echo-reply counter packets 0 bytes 0 accept
		ct state invalid counter packets 0 bytes 0 jump ufw6-logging-deny
		ct state invalid counter packets 0 bytes 0 drop
		meta l4proto ipv6-icmp icmpv6 type destination-unreachable counter packets 0 bytes 0 accept
		meta l4proto ipv6-icmp icmpv6 type packet-too-big counter packets 0 bytes 0 accept
		meta l4proto ipv6-icmp icmpv6 type time-exceeded counter packets 0 bytes 0 accept
		meta l4proto ipv6-icmp icmpv6 type parameter-problem counter packets 0 bytes 0 accept
		meta l4proto ipv6-icmp icmpv6 type echo-request counter packets 0 bytes 0 accept
		meta l4proto ipv6-icmp icmpv6 type nd-router-solicit ip6 hoplimit 255 counter packets 0 bytes 0 accept
		meta l4proto ipv6-icmp icmpv6 type nd-router-advert ip6 hoplimit 255 counter packets 0 bytes 0 accept
		meta l4proto ipv6-icmp icmpv6 type nd-neighbor-solicit ip6 hoplimit 255 counter packets 0 bytes 0 accept
		meta l4proto ipv6-icmp icmpv6 type nd-neighbor-advert ip6 hoplimit 255 counter packets 153 bytes 9800 accept
		meta l4proto ipv6-icmp xt match "icmp6" ip6 hoplimit 255 counter packets 0 bytes 0 accept
		meta l4proto ipv6-icmp xt match "icmp6" ip6 hoplimit 255 counter packets 0 bytes 0 accept
		ip6 saddr fe80::/10 meta l4proto ipv6-icmp icmpv6 type mld-listener-query counter packets 0 bytes 0 accept
		ip6 saddr fe80::/10 meta l4proto ipv6-icmp icmpv6 type mld-listener-report counter packets 0 bytes 0 accept
		ip6 saddr fe80::/10 meta l4proto ipv6-icmp icmpv6 type mld-listener-done counter packets 0 bytes 0 accept
		ip6 saddr fe80::/10 meta l4proto ipv6-icmp xt match "icmp6" counter packets 0 bytes 0 accept
		meta l4proto ipv6-icmp xt match "icmp6" ip6 hoplimit 255 counter packets 0 bytes 0 accept
		meta l4proto ipv6-icmp xt match "icmp6" ip6 hoplimit 255 counter packets 0 bytes 0 accept
		ip6 saddr fe80::/10 meta l4proto ipv6-icmp xt match "icmp6" ip6 hoplimit 1 counter packets 0 bytes 0 accept
		ip6 saddr fe80::/10 meta l4proto ipv6-icmp xt match "icmp6" ip6 hoplimit 1 counter packets 0 bytes 0 accept
		ip6 saddr fe80::/10 meta l4proto ipv6-icmp xt match "icmp6" ip6 hoplimit 1 counter packets 0 bytes 0 accept
		meta l4proto ipv6-icmp xt match "icmp6" counter packets 0 bytes 0 accept
		meta l4proto ipv6-icmp xt match "icmp6" counter packets 0 bytes 0 accept
		meta l4proto ipv6-icmp xt match "icmp6" counter packets 0 bytes 0 accept
		meta l4proto ipv6-icmp xt match "icmp6" counter packets 0 bytes 0 accept
		ip6 saddr fe80::/10 ip6 daddr fe80::/10 udp sport 547 udp dport 546 counter packets 0 bytes 0 accept
		ip6 daddr ff02::fb udp dport 5353 counter packets 0 bytes 0 accept
		ip6 daddr ff02::f udp dport 1900 counter packets 0 bytes 0 accept
		counter packets 177 bytes 12642 jump ufw6-user-input
	}

	chain ufw6-before-output {
		oifname "lo" counter packets 19854 bytes 29249559 accept
		rt type 0 counter packets 0 bytes 0 drop
		ct state related,established counter packets 22900 bytes 2898121 accept
		meta l4proto ipv6-icmp icmpv6 type destination-unreachable counter packets 0 bytes 0 accept
		meta l4proto ipv6-icmp icmpv6 type packet-too-big counter packets 0 bytes 0 accept
		meta l4proto ipv6-icmp icmpv6 type time-exceeded counter packets 0 bytes 0 accept
		meta l4proto ipv6-icmp icmpv6 type parameter-problem counter packets 0 bytes 0 accept
		meta l4proto ipv6-icmp icmpv6 type echo-request counter packets 0 bytes 0 accept
		meta l4proto ipv6-icmp icmpv6 type echo-reply counter packets 0 bytes 0 accept
		meta l4proto ipv6-icmp icmpv6 type nd-router-solicit ip6 hoplimit 255 counter packets 211 bytes 10416 accept
		meta l4proto ipv6-icmp icmpv6 type nd-neighbor-advert ip6 hoplimit 255 counter packets 0 bytes 0 accept
		meta l4proto ipv6-icmp icmpv6 type nd-neighbor-solicit ip6 hoplimit 255 counter packets 155 bytes 11160 accept
		meta l4proto ipv6-icmp icmpv6 type nd-router-advert ip6 hoplimit 255 counter packets 0 bytes 0 accept
		meta l4proto ipv6-icmp xt match "icmp6" ip6 hoplimit 255 counter packets 0 bytes 0 accept
		meta l4proto ipv6-icmp xt match "icmp6" ip6 hoplimit 255 counter packets 0 bytes 0 accept
		ip6 saddr fe80::/10 meta l4proto ipv6-icmp icmpv6 type mld-listener-query counter packets 0 bytes 0 accept
		ip6 saddr fe80::/10 meta l4proto ipv6-icmp icmpv6 type mld-listener-report counter packets 0 bytes 0 accept
		ip6 saddr fe80::/10 meta l4proto ipv6-icmp icmpv6 type mld-listener-done counter packets 0 bytes 0 accept
		ip6 saddr fe80::/10 meta l4proto ipv6-icmp xt match "icmp6" counter packets 2 bytes 192 accept
		meta l4proto ipv6-icmp xt match "icmp6" ip6 hoplimit 255 counter packets 0 bytes 0 accept
		meta l4proto ipv6-icmp xt match "icmp6" ip6 hoplimit 255 counter packets 0 bytes 0 accept
		ip6 saddr fe80::/10 meta l4proto ipv6-icmp xt match "icmp6" ip6 hoplimit 1 counter packets 0 bytes 0 accept
		ip6 saddr fe80::/10 meta l4proto ipv6-icmp xt match "icmp6" ip6 hoplimit 1 counter packets 0 bytes 0 accept
		ip6 saddr fe80::/10 meta l4proto ipv6-icmp xt match "icmp6" ip6 hoplimit 1 counter packets 0 bytes 0 accept
		counter packets 1007 bytes 81428 jump ufw6-user-output
	}

	chain ufw6-before-forward {
		rt type 0 counter packets 0 bytes 0 drop
		ct state related,established counter packets 0 bytes 0 accept
		meta l4proto ipv6-icmp icmpv6 type destination-unreachable counter packets 0 bytes 0 accept
		meta l4proto ipv6-icmp icmpv6 type packet-too-big counter packets 0 bytes 0 accept
		meta l4proto ipv6-icmp icmpv6 type time-exceeded counter packets 0 bytes 0 accept
		meta l4proto ipv6-icmp icmpv6 type parameter-problem counter packets 0 bytes 0 accept
		meta l4proto ipv6-icmp icmpv6 type echo-request counter packets 0 bytes 0 accept
		meta l4proto ipv6-icmp icmpv6 type echo-reply counter packets 0 bytes 0 accept
		counter packets 0 bytes 0 jump ufw6-user-forward
	}

	chain ufw6-after-input {
		udp dport 137 counter packets 0 bytes 0 jump ufw6-skip-to-policy-input
		udp dport 138 counter packets 0 bytes 0 jump ufw6-skip-to-policy-input
		tcp dport 139 counter packets 0 bytes 0 jump ufw6-skip-to-policy-input
		tcp dport 445 counter packets 0 bytes 0 jump ufw6-skip-to-policy-input
		udp dport 546 counter packets 0 bytes 0 jump ufw6-skip-to-policy-input
		udp dport 547 counter packets 0 bytes 0 jump ufw6-skip-to-policy-input
	}

	chain ufw6-after-output {
	}

	chain ufw6-after-forward {
	}

	chain ufw6-after-logging-input {
		limit rate 3/minute burst 10 packets counter packets 33 bytes 2110 log prefix "[UFW BLOCK] "
	}

	chain ufw6-after-logging-output {
	}

	chain ufw6-after-logging-forward {
		limit rate 3/minute burst 10 packets counter packets 0 bytes 0 log prefix "[UFW BLOCK] "
	}

	chain ufw6-reject-input {
	}

	chain ufw6-reject-output {
	}

	chain ufw6-reject-forward {
	}

	chain ufw6-track-input {
	}

	chain ufw6-track-output {
		meta l4proto tcp ct state new counter packets 951 bytes 76080 accept
		meta l4proto udp ct state new counter packets 53 bytes 5080 accept
	}

	chain ufw6-track-forward {
	}

	chain INPUT {
		type filter hook input priority filter; policy drop;
		counter packets 56285 bytes 575970889 jump ufw6-before-logging-input
		counter packets 56285 bytes 575970889 jump ufw6-before-input
		counter packets 172 bytes 11178 jump ufw6-after-input
		counter packets 172 bytes 11178 jump ufw6-after-logging-input
		counter packets 172 bytes 11178 jump ufw6-reject-input
		counter packets 172 bytes 11178 jump ufw6-track-input
	}

	chain OUTPUT {
		type filter hook output priority filter; policy accept;
		counter packets 44129 bytes 32250876 jump ufw6-before-logging-output
		counter packets 44129 bytes 32250876 jump ufw6-before-output
		counter packets 1007 bytes 81428 jump ufw6-after-output
		counter packets 1007 bytes 81428 jump ufw6-after-logging-output
		counter packets 1007 bytes 81428 jump ufw6-reject-output
		counter packets 1007 bytes 81428 jump ufw6-track-output
	}

	chain FORWARD {
		type filter hook forward priority filter; policy drop;
		counter packets 0 bytes 0 jump ufw6-before-logging-forward
		counter packets 0 bytes 0 jump ufw6-before-forward
		counter packets 0 bytes 0 jump ufw6-after-forward
		counter packets 0 bytes 0 jump ufw6-after-logging-forward
		counter packets 0 bytes 0 jump ufw6-reject-forward
		counter packets 0 bytes 0 jump ufw6-track-forward
	}

	chain ufw6-logging-deny {
		ct state invalid limit rate 3/minute burst 10 packets counter packets 0 bytes 0 return
		limit rate 3/minute burst 10 packets counter packets 0 bytes 0 log prefix "[UFW BLOCK] "
	}

	chain ufw6-logging-allow {
		limit rate 3/minute burst 10 packets counter packets 0 bytes 0 log prefix "[UFW ALLOW] "
	}

	chain ufw6-skip-to-policy-input {
		counter packets 0 bytes 0 drop
	}

	chain ufw6-skip-to-policy-output {
		counter packets 0 bytes 0 accept
	}

	chain ufw6-skip-to-policy-forward {
		counter packets 0 bytes 0 drop
	}

	chain ufw6-user-input {
		tcp dport 443 counter packets 0 bytes 0 accept
		tcp dport 5000 counter packets 0 bytes 0 accept
		tcp dport 22 counter packets 0 bytes 0 accept
		tcp dport 22  counter packets 0 bytes 0 accept
		udp dport 5000 counter packets 0 bytes 0 accept
		meta l4proto udp udp dport { 500, 4500 } counter packets 0 bytes 0 accept
		tcp dport 3000 counter packets 0 bytes 0 accept
	}

	chain ufw6-user-output {
	}

	chain ufw6-user-forward {
	}

	chain ufw6-user-logging-input {
	}

	chain ufw6-user-logging-output {
	}

	chain ufw6-user-logging-forward {
	}

	chain ufw6-user-limit {
		limit rate 3/minute burst 5 packets counter packets 0 bytes 0 log prefix "[UFW LIMIT BLOCK] "
		counter packets 0 bytes 0 reject
	}

	chain ufw6-user-limit-accept {
		counter packets 0 bytes 0 accept
	}
}
table ip nat {
	chain POSTROUTING {
		type nat hook postrouting priority srcnat; policy accept;
		ip saddr 10.8.0.0/24 oifname "eth0" counter packets 0 bytes 0 masquerade
		ip saddr 10.8.0.0/24 oifname "eth0" counter packets 0 bytes 0 masquerade
		ip saddr 10.8.0.0/24 oifname "eth0" counter packets 0 bytes 0 masquerade
		ip saddr 10.8.0.0/24 oifname "eth0" counter packets 0 bytes 0 masquerade
		ip saddr 10.8.0.0/24 oifname "eth0" counter packets 0 bytes 0 masquerade
		ip saddr 10.8.0.0/24 oifname "eth0" counter packets 0 bytes 0 masquerade
		ip saddr 10.8.0.0/24 oifname "eth0" counter packets 0 bytes 0 masquerade
		ip saddr 10.8.0.0/24 oifname "eth0" counter packets 0 bytes 0 masquerade
		ip saddr 10.8.0.0/24 oifname "eth0" counter packets 0 bytes 0 masquerade
		ip saddr 10.8.0.0/24 oifname "eth0" counter packets 0 bytes 0 masquerade
		ip saddr 10.8.0.0/24 oifname "eth0" counter packets 0 bytes 0 masquerade
		ip saddr 10.8.0.0/24 oifname "eth0" counter packets 0 bytes 0 masquerade
		ip saddr 10.8.0.0/24 oifname "eth0" counter packets 0 bytes 0 masquerade
		ip saddr 10.8.0.0/24 oifname "eth0" counter packets 0 bytes 0 masquerade
		ip saddr 10.8.0.0/24 oifname "eth0" counter packets 0 bytes 0 masquerade
		ip saddr 10.8.0.0/24 oifname "eth0" counter packets 0 bytes 0 masquerade
		ip saddr 10.8.0.0/24 oifname "eth0" counter packets 0 bytes 0 masquerade
		ip saddr 10.8.0.0/24 oifname "eth0" counter packets 0 bytes 0 masquerade
		ip saddr 10.8.0.0/24 oifname "eth0" counter packets 0 bytes 0 masquerade
		ip saddr 10.8.0.0/24 oifname "eth0" counter packets 0 bytes 0 masquerade
	}
}

# --- systemctl running ---
  UNIT                        LOAD   ACTIVE SUB     DESCRIPTION
  atd.service                 loaded active running Deferred execution scheduler
  blackbox_exporter.service   loaded active running Blackbox Exporter
  cron.service                loaded active running Regular background program processing daemon
  dbus.service                loaded active running D-Bus System Message Bus
  getty@tty1.service          loaded active running Getty on tty1
  grafana-server.service      loaded active running Grafana instance
  multipathd.service          loaded active running Device-Mapper Multipath Device Controller
  named.service               loaded active running BIND Domain Name Server
  node_exporter.service       loaded active running Node Exporter
  polkit.service              loaded active running Authorization Manager
  prometheus.service          loaded active running Prometheus Monitoring
  qemu-guest-agent.service    loaded active running QEMU Guest Agent
  rsyslog.service             loaded active running System Logging Service
  serial-getty@ttyS0.service  loaded active running Serial Getty on ttyS0
  snapd.service               loaded active running Snap Daemon
  socks5tun.service           loaded active running SOCKS5TUN proxy server
  ssh.service                 loaded active running OpenBSD Secure Shell server
  strongswan.service          loaded active running strongSwan IPsec IKEv1/IKEv2 daemon using swanctl
  stunnel.service             loaded active running TLS wrapper for SOCKS5TUN
  systemd-journald.service    loaded active running Journal Service
  systemd-logind.service      loaded active running User Login Management
  systemd-networkd.service    loaded active running Network Configuration
  systemd-resolved.service    loaded active running Network Name Resolution
  systemd-timesyncd.service   loaded active running Network Time Synchronization
  systemd-udevd.service       loaded active running Rule-based Manager for Device Events and Files
  unattended-upgrades.service loaded active running Unattended Upgrades Shutdown
  user@0.service              loaded active running User Manager for UID 0

Legend: LOAD   → Reflects whether the unit definition was properly loaded.
        ACTIVE → The high-level unit activation state, i.e. generalization of SUB.
        SUB    → The low-level unit activation state, values depend on unit type.

27 loaded units listed.

# --- ss -tunlp ---
Netid State  Recv-Q Send-Q                    Local Address:Port  Peer Address:PortProcess                                                   
udp   UNCONN 0      0                              10.8.0.1:53         0.0.0.0:*    users:(("named",pid=829,fd=54))                          
udp   UNCONN 0      0                              10.8.0.1:53         0.0.0.0:*    users:(("named",pid=829,fd=55))                          
udp   UNCONN 0      0                            127.0.0.54:53         0.0.0.0:*    users:(("systemd-resolve",pid=2761,fd=16))               
udp   UNCONN 0      0                         127.0.0.53%lo:53         0.0.0.0:*    users:(("systemd-resolve",pid=2761,fd=14))               
udp   UNCONN 0      0                          46.62.133.47:53         0.0.0.0:*    users:(("named",pid=829,fd=34))                          
udp   UNCONN 0      0                          46.62.133.47:53         0.0.0.0:*    users:(("named",pid=829,fd=35))                          
udp   UNCONN 0      0                             127.0.0.1:53         0.0.0.0:*    users:(("named",pid=829,fd=29))                          
udp   UNCONN 0      0                             127.0.0.1:53         0.0.0.0:*    users:(("named",pid=829,fd=28))                          
udp   UNCONN 0      0                     46.62.133.47%eth0:68         0.0.0.0:*    users:(("systemd-network",pid=771,fd=22))                
udp   UNCONN 0      0                               0.0.0.0:68         0.0.0.0:*    users:(("charon-systemd",pid=838,fd=26))                 
udp   UNCONN 0      0                               0.0.0.0:4500       0.0.0.0:*    users:(("charon-systemd",pid=838,fd=19))                 
udp   UNCONN 0      0                               0.0.0.0:500        0.0.0.0:*    users:(("charon-systemd",pid=838,fd=18))                 
udp   UNCONN 0      0                               0.0.0.0:5000       0.0.0.0:*    users:(("python",pid=132653,fd=4))                       
udp   UNCONN 0      0                                 [::1]:53            [::]:*    users:(("named",pid=829,fd=38))                          
udp   UNCONN 0      0                                 [::1]:53            [::]:*    users:(("named",pid=829,fd=39))                          
udp   UNCONN 0      0                [2a01:4f9:c013:5d3::1]:53            [::]:*    users:(("named",pid=829,fd=42))                          
udp   UNCONN 0      0                [2a01:4f9:c013:5d3::1]:53            [::]:*    users:(("named",pid=829,fd=43))                          
udp   UNCONN 0      0       [fe80::9400:4ff:fe64:d85e]%eth0:53            [::]:*    users:(("named",pid=829,fd=47))                          
udp   UNCONN 0      0       [fe80::9400:4ff:fe64:d85e]%eth0:53            [::]:*    users:(("named",pid=829,fd=46))                          
udp   UNCONN 0      0      [fe80::65eb:cb73:9bac:9e50]%tun0:53            [::]:*    users:(("named",pid=829,fd=60))                          
udp   UNCONN 0      0      [fe80::65eb:cb73:9bac:9e50]%tun0:53            [::]:*    users:(("named",pid=829,fd=59))                          
udp   UNCONN 0      0                                  [::]:4500          [::]:*    users:(("charon-systemd",pid=838,fd=17))                 
udp   UNCONN 0      0                                  [::]:500           [::]:*    users:(("charon-systemd",pid=838,fd=16))                 
tcp   LISTEN 0      10                            127.0.0.1:53         0.0.0.0:*    users:(("named",pid=829,fd=32))                          
tcp   LISTEN 0      10                            127.0.0.1:53         0.0.0.0:*    users:(("named",pid=829,fd=30))                          
tcp   LISTEN 0      5                             127.0.0.1:953        0.0.0.0:*    users:(("named",pid=829,fd=51))                          
tcp   LISTEN 0      5                             127.0.0.1:953        0.0.0.0:*    users:(("named",pid=829,fd=50))                          
tcp   LISTEN 0      10                         46.62.133.47:53         0.0.0.0:*    users:(("named",pid=829,fd=37))                          
tcp   LISTEN 0      10                         46.62.133.47:53         0.0.0.0:*    users:(("named",pid=829,fd=36))                          
tcp   LISTEN 0      4096                         127.0.0.54:53         0.0.0.0:*    users:(("systemd-resolve",pid=2761,fd=17))               
tcp   LISTEN 0      128                             0.0.0.0:5000       0.0.0.0:*    users:(("python",pid=132653,fd=5))                       
tcp   LISTEN 0      1024                          127.0.0.1:40599      0.0.0.0:*    users:(("code-c306e94f98",pid=89049,fd=9))               
tcp   LISTEN 0      4096                      127.0.0.53%lo:53         0.0.0.0:*    users:(("systemd-resolve",pid=2761,fd=15))               
tcp   LISTEN 0      4096                            0.0.0.0:443        0.0.0.0:*    users:(("stunnel",pid=7796,fd=9))                        
tcp   LISTEN 0      4096                            0.0.0.0:22         0.0.0.0:*    users:(("sshd",pid=119318,fd=3),("systemd",pid=1,fd=239))
tcp   LISTEN 0      10                             10.8.0.1:53         0.0.0.0:*    users:(("named",pid=829,fd=56))                          
tcp   LISTEN 0      10                             10.8.0.1:53         0.0.0.0:*    users:(("named",pid=829,fd=58))                          
tcp   LISTEN 0      5                                 [::1]:953           [::]:*    users:(("named",pid=829,fd=53))                          
tcp   LISTEN 0      5                                 [::1]:953           [::]:*    users:(("named",pid=829,fd=52))                          
tcp   LISTEN 0      10                                [::1]:53            [::]:*    users:(("named",pid=829,fd=41))                          
tcp   LISTEN 0      10                                [::1]:53            [::]:*    users:(("named",pid=829,fd=40))                          
tcp   LISTEN 0      4096                                  *:9100             *:*    users:(("node_exporter",pid=125716,fd=3))                
tcp   LISTEN 0      4096                                  *:9090             *:*    users:(("prometheus",pid=125029,fd=7))                   
tcp   LISTEN 0      4096                                  *:9115             *:*    users:(("blackbox_export",pid=124237,fd=3))              
tcp   LISTEN 0      4096                                  *:3000             *:*    users:(("grafana",pid=121770,fd=11))                     
tcp   LISTEN 0      10      [fe80::9400:4ff:fe64:d85e]%eth0:53            [::]:*    users:(("named",pid=829,fd=48))                          
tcp   LISTEN 0      10      [fe80::9400:4ff:fe64:d85e]%eth0:53            [::]:*    users:(("named",pid=829,fd=49))                          
tcp   LISTEN 0      10     [fe80::65eb:cb73:9bac:9e50]%tun0:53            [::]:*    users:(("named",pid=829,fd=62))                          
tcp   LISTEN 0      10     [fe80::65eb:cb73:9bac:9e50]%tun0:53            [::]:*    users:(("named",pid=829,fd=61))                          
tcp   LISTEN 0      10               [2a01:4f9:c013:5d3::1]:53            [::]:*    users:(("named",pid=829,fd=44))                          
tcp   LISTEN 0      10               [2a01:4f9:c013:5d3::1]:53            [::]:*    users:(("named",pid=829,fd=45))                          
tcp   LISTEN 0      511                                   *:4119             *:*    users:(("node",pid=89705,fd=23))                         
tcp   LISTEN 0      4096                               [::]:22            [::]:*    users:(("sshd",pid=119318,fd=4),("systemd",pid=1,fd=240))

# --- journal socks5tun ---
Aug 08 14:26:07 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:26:07 [INFO] [MainThread] [LOCAL] TCP connection from 127.0.0.1:40832 (132653 python)
Aug 08 14:26:07 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:26:07 [WARNING] [Thread-157 (_handle_client)] 👀 LOCAL connection from 127.0.0.1 — likely self-initiated
Aug 08 14:26:07 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:26:07 [INFO] [Thread-157 (_handle_client)] 🔁 [LOCAL/SELF] Connection from 127.0.0.1 closed prematurely (132653 python)
Aug 08 14:26:22 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:26:22 [INFO] [MainThread] [LOCAL] TCP connection from 127.0.0.1:48918 (132653 python)
Aug 08 14:26:22 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:26:22 [WARNING] [Thread-158 (_handle_client)] 👀 LOCAL connection from 127.0.0.1 — likely self-initiated
Aug 08 14:26:22 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:26:22 [INFO] [Thread-158 (_handle_client)] 🔁 [LOCAL/SELF] Connection from 127.0.0.1 closed prematurely (132653 python)
Aug 08 14:26:37 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:26:37 [INFO] [MainThread] [LOCAL] TCP connection from 127.0.0.1:56130 (132653 python)
Aug 08 14:26:37 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:26:37 [WARNING] [Thread-159 (_handle_client)] 👀 LOCAL connection from 127.0.0.1 — likely self-initiated
Aug 08 14:26:37 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:26:37 [INFO] [Thread-159 (_handle_client)] 🔁 [LOCAL/SELF] Connection from 127.0.0.1 closed prematurely (132653 python)
Aug 08 14:26:52 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:26:52 [INFO] [MainThread] [LOCAL] TCP connection from 127.0.0.1:40174 (132653 python)
Aug 08 14:26:52 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:26:52 [WARNING] [Thread-160 (_handle_client)] 👀 LOCAL connection from 127.0.0.1 — likely self-initiated
Aug 08 14:26:52 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:26:52 [INFO] [Thread-160 (_handle_client)] 🔁 [LOCAL/SELF] Connection from 127.0.0.1 closed prematurely (132653 python)
Aug 08 14:27:07 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:27:07 [INFO] [MainThread] [LOCAL] TCP connection from 127.0.0.1:46820 (132653 python)
Aug 08 14:27:07 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:27:07 [WARNING] [Thread-161 (_handle_client)] 👀 LOCAL connection from 127.0.0.1 — likely self-initiated
Aug 08 14:27:07 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:27:07 [INFO] [Thread-161 (_handle_client)] 🔁 [LOCAL/SELF] Connection from 127.0.0.1 closed prematurely (132653 python)
Aug 08 14:27:22 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:27:22 [INFO] [MainThread] [LOCAL] TCP connection from 127.0.0.1:43714 (132653 python)
Aug 08 14:27:22 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:27:22 [WARNING] [Thread-162 (_handle_client)] 👀 LOCAL connection from 127.0.0.1 — likely self-initiated
Aug 08 14:27:22 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:27:22 [INFO] [Thread-162 (_handle_client)] 🔁 [LOCAL/SELF] Connection from 127.0.0.1 closed prematurely (132653 python)
Aug 08 14:27:37 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:27:37 [INFO] [MainThread] [LOCAL] TCP connection from 127.0.0.1:33056 (132653 python)
Aug 08 14:27:37 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:27:37 [WARNING] [Thread-163 (_handle_client)] 👀 LOCAL connection from 127.0.0.1 — likely self-initiated
Aug 08 14:27:37 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:27:37 [INFO] [Thread-163 (_handle_client)] 🔁 [LOCAL/SELF] Connection from 127.0.0.1 closed prematurely (132653 python)
Aug 08 14:27:52 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:27:52 [INFO] [MainThread] [LOCAL] TCP connection from 127.0.0.1:51192 (132653 python)
Aug 08 14:27:52 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:27:52 [WARNING] [Thread-164 (_handle_client)] 👀 LOCAL connection from 127.0.0.1 — likely self-initiated
Aug 08 14:27:52 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:27:52 [INFO] [Thread-164 (_handle_client)] 🔁 [LOCAL/SELF] Connection from 127.0.0.1 closed prematurely (132653 python)
Aug 08 14:28:07 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:28:07 [INFO] [MainThread] [LOCAL] TCP connection from 127.0.0.1:42070 (132653 python)
Aug 08 14:28:07 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:28:07 [WARNING] [Thread-165 (_handle_client)] 👀 LOCAL connection from 127.0.0.1 — likely self-initiated
Aug 08 14:28:07 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:28:07 [INFO] [Thread-165 (_handle_client)] 🔁 [LOCAL/SELF] Connection from 127.0.0.1 closed prematurely (132653 python)
Aug 08 14:28:22 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:28:22 [INFO] [MainThread] [LOCAL] TCP connection from 127.0.0.1:58664 (132653 python)
Aug 08 14:28:22 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:28:22 [WARNING] [Thread-166 (_handle_client)] 👀 LOCAL connection from 127.0.0.1 — likely self-initiated
Aug 08 14:28:22 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:28:22 [INFO] [Thread-166 (_handle_client)] 🔁 [LOCAL/SELF] Connection from 127.0.0.1 closed prematurely (132653 python)
Aug 08 14:28:37 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:28:37 [INFO] [MainThread] [LOCAL] TCP connection from 127.0.0.1:42204 (132653 python)
Aug 08 14:28:37 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:28:37 [WARNING] [Thread-167 (_handle_client)] 👀 LOCAL connection from 127.0.0.1 — likely self-initiated
Aug 08 14:28:37 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:28:37 [INFO] [Thread-167 (_handle_client)] 🔁 [LOCAL/SELF] Connection from 127.0.0.1 closed prematurely (132653 python)
Aug 08 14:28:52 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:28:52 [INFO] [MainThread] [LOCAL] TCP connection from 127.0.0.1:52810 (132653 python)
Aug 08 14:28:52 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:28:52 [WARNING] [Thread-168 (_handle_client)] 👀 LOCAL connection from 127.0.0.1 — likely self-initiated
Aug 08 14:28:52 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:28:52 [INFO] [Thread-168 (_handle_client)] 🔁 [LOCAL/SELF] Connection from 127.0.0.1 closed prematurely (132653 python)
Aug 08 14:29:07 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:29:07 [INFO] [MainThread] [LOCAL] TCP connection from 127.0.0.1:38790 (132653 python)
Aug 08 14:29:07 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:29:07 [WARNING] [Thread-169 (_handle_client)] 👀 LOCAL connection from 127.0.0.1 — likely self-initiated
Aug 08 14:29:07 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:29:07 [INFO] [Thread-169 (_handle_client)] 🔁 [LOCAL/SELF] Connection from 127.0.0.1 closed prematurely (132653 python)
Aug 08 14:29:22 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:29:22 [INFO] [MainThread] [LOCAL] TCP connection from 127.0.0.1:35440 (132653 python)
Aug 08 14:29:22 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:29:22 [WARNING] [Thread-170 (_handle_client)] 👀 LOCAL connection from 127.0.0.1 — likely self-initiated
Aug 08 14:29:22 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:29:22 [INFO] [Thread-170 (_handle_client)] 🔁 [LOCAL/SELF] Connection from 127.0.0.1 closed prematurely (132653 python)
Aug 08 14:29:37 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:29:37 [INFO] [MainThread] [LOCAL] TCP connection from 127.0.0.1:50498 (132653 python)
Aug 08 14:29:37 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:29:37 [WARNING] [Thread-171 (_handle_client)] 👀 LOCAL connection from 127.0.0.1 — likely self-initiated
Aug 08 14:29:37 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:29:37 [INFO] [Thread-171 (_handle_client)] 🔁 [LOCAL/SELF] Connection from 127.0.0.1 closed prematurely (132653 python)
Aug 08 14:29:52 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:29:52 [INFO] [MainThread] [LOCAL] TCP connection from 127.0.0.1:42176 (132653 python)
Aug 08 14:29:52 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:29:52 [WARNING] [Thread-172 (_handle_client)] 👀 LOCAL connection from 127.0.0.1 — likely self-initiated
Aug 08 14:29:52 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:29:52 [INFO] [Thread-172 (_handle_client)] 🔁 [LOCAL/SELF] Connection from 127.0.0.1 closed prematurely (132653 python)
Aug 08 14:30:07 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:30:07 [INFO] [MainThread] [LOCAL] TCP connection from 127.0.0.1:35366 (132653 python)
Aug 08 14:30:07 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:30:07 [WARNING] [Thread-173 (_handle_client)] 👀 LOCAL connection from 127.0.0.1 — likely self-initiated
Aug 08 14:30:07 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:30:07 [INFO] [Thread-173 (_handle_client)] 🔁 [LOCAL/SELF] Connection from 127.0.0.1 closed prematurely (132653 python)
Aug 08 14:30:22 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:30:22 [INFO] [MainThread] [LOCAL] TCP connection from 127.0.0.1:49878 (132653 python)
Aug 08 14:30:22 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:30:22 [WARNING] [Thread-174 (_handle_client)] 👀 LOCAL connection from 127.0.0.1 — likely self-initiated
Aug 08 14:30:22 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:30:22 [INFO] [Thread-174 (_handle_client)] 🔁 [LOCAL/SELF] Connection from 127.0.0.1 closed prematurely (132653 python)
Aug 08 14:30:37 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:30:37 [INFO] [MainThread] [LOCAL] TCP connection from 127.0.0.1:50206 (132653 python)
Aug 08 14:30:37 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:30:37 [WARNING] [Thread-175 (_handle_client)] 👀 LOCAL connection from 127.0.0.1 — likely self-initiated
Aug 08 14:30:37 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:30:37 [INFO] [Thread-175 (_handle_client)] 🔁 [LOCAL/SELF] Connection from 127.0.0.1 closed prematurely (132653 python)
Aug 08 14:30:50 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:30:50 [INFO] [MainThread] [LOCAL] TCP connection from 127.0.0.1:37678 (132653 python)
Aug 08 14:30:50 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:30:50 [WARNING] [Thread-176 (_handle_client)] 👀 LOCAL connection from 127.0.0.1 — likely self-initiated
Aug 08 14:30:50 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:30:50 [WARNING] [Thread-176 (_handle_client)] [SNIFF] First 2 bytes from 127.0.0.1:37678: hex=0502 ascii=b'\x05\x02'
Aug 08 14:30:50 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:30:50 [INFO] [Thread-176 (_handle_client)] SOCKS5 handshake header from 127.0.0.1: 0502
Aug 08 14:30:50 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:30:50 [INFO] [Thread-176 (_handle_client)] SOCKS5 methods from 127.0.0.1: 0001
Aug 08 14:30:50 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:30:50 [DEBUG] [Thread-176 (_handle_client)] [DEBUG] Waiting for SOCKS5 request from 127.0.0.1:37678...
Aug 08 14:30:50 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:30:50 [DEBUG] [Thread-176 (_handle_client)] [DEBUG] Waiting for SOCKS5 request from 127.0.0.1:37678...
Aug 08 14:30:50 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:30:50 [INFO] [Thread-176 (_handle_client)] SOCKS5 request header from 127.0.0.1: 05010003
Aug 08 14:30:50 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:30:50 [INFO] [Thread-176 (_handle_client)] Established TCP tunnel from 127.0.0.1 to 104.21.54.91:443
Aug 08 14:30:50 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:30:50 [INFO] [Thread-176 (_handle_client)] Closed TCP tunnel for 127.0.0.1
Aug 08 14:30:52 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:30:52 [INFO] [MainThread] [LOCAL] TCP connection from 127.0.0.1:42100 (132653 python)
Aug 08 14:30:52 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:30:52 [WARNING] [Thread-177 (_handle_client)] 👀 LOCAL connection from 127.0.0.1 — likely self-initiated
Aug 08 14:30:52 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:30:52 [INFO] [Thread-177 (_handle_client)] 🔁 [LOCAL/SELF] Connection from 127.0.0.1 closed prematurely (132653 python)
Aug 08 14:31:07 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:31:07 [INFO] [MainThread] [LOCAL] TCP connection from 127.0.0.1:49878 (132653 python)
Aug 08 14:31:07 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:31:07 [WARNING] [Thread-178 (_handle_client)] 👀 LOCAL connection from 127.0.0.1 — likely self-initiated
Aug 08 14:31:07 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:31:07 [INFO] [Thread-178 (_handle_client)] 🔁 [LOCAL/SELF] Connection from 127.0.0.1 closed prematurely (132653 python)
Aug 08 14:31:22 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:31:22 [INFO] [MainThread] [LOCAL] TCP connection from 127.0.0.1:56076 (132653 python)
Aug 08 14:31:22 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:31:22 [WARNING] [Thread-179 (_handle_client)] 👀 LOCAL connection from 127.0.0.1 — likely self-initiated
Aug 08 14:31:22 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:31:22 [INFO] [Thread-179 (_handle_client)] 🔁 [LOCAL/SELF] Connection from 127.0.0.1 closed prematurely (132653 python)
Aug 08 14:31:37 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:31:37 [INFO] [MainThread] [LOCAL] TCP connection from 127.0.0.1:33318 (132653 python)
Aug 08 14:31:37 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:31:37 [WARNING] [Thread-180 (_handle_client)] 👀 LOCAL connection from 127.0.0.1 — likely self-initiated
Aug 08 14:31:37 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:31:37 [INFO] [Thread-180 (_handle_client)] 🔁 [LOCAL/SELF] Connection from 127.0.0.1 closed prematurely (132653 python)
Aug 08 14:31:52 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:31:52 [INFO] [MainThread] [LOCAL] TCP connection from 127.0.0.1:43894 (132653 python)
Aug 08 14:31:52 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:31:52 [WARNING] [Thread-181 (_handle_client)] 👀 LOCAL connection from 127.0.0.1 — likely self-initiated
Aug 08 14:31:52 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:31:52 [INFO] [Thread-181 (_handle_client)] 🔁 [LOCAL/SELF] Connection from 127.0.0.1 closed prematurely (132653 python)
Aug 08 14:32:07 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:32:07 [INFO] [MainThread] [LOCAL] TCP connection from 127.0.0.1:43718 (132653 python)
Aug 08 14:32:07 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:32:07 [WARNING] [Thread-182 (_handle_client)] 👀 LOCAL connection from 127.0.0.1 — likely self-initiated
Aug 08 14:32:07 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:32:07 [INFO] [Thread-182 (_handle_client)] 🔁 [LOCAL/SELF] Connection from 127.0.0.1 closed prematurely (132653 python)
Aug 08 14:32:22 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:32:22 [INFO] [MainThread] [LOCAL] TCP connection from 127.0.0.1:58560 (132653 python)
Aug 08 14:32:22 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:32:22 [WARNING] [Thread-183 (_handle_client)] 👀 LOCAL connection from 127.0.0.1 — likely self-initiated
Aug 08 14:32:22 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:32:22 [INFO] [Thread-183 (_handle_client)] 🔁 [LOCAL/SELF] Connection from 127.0.0.1 closed prematurely (132653 python)
Aug 08 14:32:37 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:32:37 [INFO] [MainThread] [LOCAL] TCP connection from 127.0.0.1:58916 (132653 python)
Aug 08 14:32:37 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:32:37 [WARNING] [Thread-184 (_handle_client)] 👀 LOCAL connection from 127.0.0.1 — likely self-initiated
Aug 08 14:32:37 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:32:37 [INFO] [Thread-184 (_handle_client)] 🔁 [LOCAL/SELF] Connection from 127.0.0.1 closed prematurely (132653 python)
Aug 08 14:32:52 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:32:52 [INFO] [MainThread] [LOCAL] TCP connection from 127.0.0.1:37188 (132653 python)
Aug 08 14:32:52 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:32:52 [WARNING] [Thread-185 (_handle_client)] 👀 LOCAL connection from 127.0.0.1 — likely self-initiated
Aug 08 14:32:52 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:32:52 [INFO] [Thread-185 (_handle_client)] 🔁 [LOCAL/SELF] Connection from 127.0.0.1 closed prematurely (132653 python)
Aug 08 14:33:07 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:33:07 [INFO] [MainThread] [LOCAL] TCP connection from 127.0.0.1:56856 (132653 python)
Aug 08 14:33:07 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:33:07 [WARNING] [Thread-186 (_handle_client)] 👀 LOCAL connection from 127.0.0.1 — likely self-initiated
Aug 08 14:33:07 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:33:07 [INFO] [Thread-186 (_handle_client)] 🔁 [LOCAL/SELF] Connection from 127.0.0.1 closed prematurely (132653 python)
Aug 08 14:33:22 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:33:22 [INFO] [MainThread] [LOCAL] TCP connection from 127.0.0.1:34372 (132653 python)
Aug 08 14:33:22 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:33:22 [WARNING] [Thread-187 (_handle_client)] 👀 LOCAL connection from 127.0.0.1 — likely self-initiated
Aug 08 14:33:22 ubuntu-4gb-hel1-2 python[132653]: 2025-08-08 14:33:22 [INFO] [Thread-187 (_handle_client)] 🔁 [LOCAL/SELF] Connection from 127.0.0.1 closed prematurely (132653 python)

# --- pip freeze ---
build==1.3.0
debugpy==1.8.15
iniconfig==2.1.0
packaging==25.0
pluggy==1.6.0
psutil==7.0.0
Pygments==2.19.2
pyproject_hooks==1.2.0
pyroute2==0.9.3
pytest==8.4.1
pytest-timeout==2.4.0
socks5tun @ file:///opt/socks5tun
types-psutil==7.0.0.20250801

# --- iptables-save ---
# Generated by iptables-save v1.8.10 (nf_tables) on Fri Aug  8 14:33:27 2025
*filter
:INPUT DROP [13497:1837934]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [118:7736]
:ufw-after-forward - [0:0]
:ufw-after-input - [0:0]
:ufw-after-logging-forward - [0:0]
:ufw-after-logging-input - [0:0]
:ufw-after-logging-output - [0:0]
:ufw-after-output - [0:0]
:ufw-before-forward - [0:0]
:ufw-before-input - [0:0]
:ufw-before-logging-forward - [0:0]
:ufw-before-logging-input - [0:0]
:ufw-before-logging-output - [0:0]
:ufw-before-output - [0:0]
:ufw-logging-allow - [0:0]
:ufw-logging-deny - [0:0]
:ufw-not-local - [0:0]
:ufw-reject-forward - [0:0]
:ufw-reject-input - [0:0]
:ufw-reject-output - [0:0]
:ufw-skip-to-policy-forward - [0:0]
:ufw-skip-to-policy-input - [0:0]
:ufw-skip-to-policy-output - [0:0]
:ufw-track-forward - [0:0]
:ufw-track-input - [0:0]
:ufw-track-output - [0:0]
:ufw-user-forward - [0:0]
:ufw-user-input - [0:0]
:ufw-user-limit - [0:0]
:ufw-user-limit-accept - [0:0]
:ufw-user-logging-forward - [0:0]
:ufw-user-logging-input - [0:0]
:ufw-user-logging-output - [0:0]
:ufw-user-output - [0:0]
-A INPUT -j ufw-before-logging-input
-A INPUT -j ufw-before-input
-A INPUT -j ufw-after-input
-A INPUT -j ufw-after-logging-input
-A INPUT -j ufw-reject-input
-A INPUT -j ufw-track-input
-A FORWARD -j ufw-before-logging-forward
-A FORWARD -j ufw-before-forward
-A FORWARD -j ufw-after-forward
-A FORWARD -j ufw-after-logging-forward
-A FORWARD -j ufw-reject-forward
-A FORWARD -j ufw-track-forward
-A OUTPUT -j ufw-before-logging-output
-A OUTPUT -j ufw-before-output
-A OUTPUT -j ufw-after-output
-A OUTPUT -j ufw-after-logging-output
-A OUTPUT -j ufw-reject-output
-A OUTPUT -j ufw-track-output
-A ufw-after-input -p udp -m udp --dport 137 -j ufw-skip-to-policy-input
-A ufw-after-input -p udp -m udp --dport 138 -j ufw-skip-to-policy-input
-A ufw-after-input -p tcp -m tcp --dport 139 -j ufw-skip-to-policy-input
-A ufw-after-input -p tcp -m tcp --dport 445 -j ufw-skip-to-policy-input
-A ufw-after-input -p udp -m udp --dport 67 -j ufw-skip-to-policy-input
-A ufw-after-input -p udp -m udp --dport 68 -j ufw-skip-to-policy-input
-A ufw-after-input -m addrtype --dst-type BROADCAST -j ufw-skip-to-policy-input
-A ufw-after-logging-forward -m limit --limit 3/min --limit-burst 10 -j LOG --log-prefix "[UFW BLOCK] "
-A ufw-after-logging-input -m limit --limit 3/min --limit-burst 10 -j LOG --log-prefix "[UFW BLOCK] "
-A ufw-before-forward -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A ufw-before-forward -p icmp -m icmp --icmp-type 3 -j ACCEPT
-A ufw-before-forward -p icmp -m icmp --icmp-type 11 -j ACCEPT
-A ufw-before-forward -p icmp -m icmp --icmp-type 12 -j ACCEPT
-A ufw-before-forward -p icmp -m icmp --icmp-type 8 -j ACCEPT
-A ufw-before-forward -j ufw-user-forward
-A ufw-before-input -i lo -j ACCEPT
-A ufw-before-input -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A ufw-before-input -m conntrack --ctstate INVALID -j ufw-logging-deny
-A ufw-before-input -m conntrack --ctstate INVALID -j DROP
-A ufw-before-input -p icmp -m icmp --icmp-type 3 -j ACCEPT
-A ufw-before-input -p icmp -m icmp --icmp-type 11 -j ACCEPT
-A ufw-before-input -p icmp -m icmp --icmp-type 12 -j ACCEPT
-A ufw-before-input -p icmp -m icmp --icmp-type 8 -j ACCEPT
-A ufw-before-input -p udp -m udp --sport 67 --dport 68 -j ACCEPT
-A ufw-before-input -j ufw-not-local
-A ufw-before-input -d 224.0.0.251/32 -p udp -m udp --dport 5353 -j ACCEPT
-A ufw-before-input -d 239.255.255.250/32 -p udp -m udp --dport 1900 -j ACCEPT
-A ufw-before-input -j ufw-user-input
-A ufw-before-output -o lo -j ACCEPT
-A ufw-before-output -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A ufw-before-output -j ufw-user-output
-A ufw-logging-allow -m limit --limit 3/min --limit-burst 10 -j LOG --log-prefix "[UFW ALLOW] "
-A ufw-logging-deny -m conntrack --ctstate INVALID -m limit --limit 3/min --limit-burst 10 -j RETURN
-A ufw-logging-deny -m limit --limit 3/min --limit-burst 10 -j LOG --log-prefix "[UFW BLOCK] "
-A ufw-not-local -m addrtype --dst-type LOCAL -j RETURN
-A ufw-not-local -m addrtype --dst-type MULTICAST -j RETURN
-A ufw-not-local -m addrtype --dst-type BROADCAST -j RETURN
-A ufw-not-local -m limit --limit 3/min --limit-burst 10 -j ufw-logging-deny
-A ufw-not-local -j DROP
-A ufw-skip-to-policy-forward -j DROP
-A ufw-skip-to-policy-input -j DROP
-A ufw-skip-to-policy-output -j ACCEPT
-A ufw-track-output -p tcp -m conntrack --ctstate NEW -j ACCEPT
-A ufw-track-output -p udp -m conntrack --ctstate NEW -j ACCEPT
-A ufw-user-input -p tcp -m tcp --dport 443 -j ACCEPT
-A ufw-user-input -p tcp -m tcp --dport 5000 -j ACCEPT
-A ufw-user-input -p tcp -m tcp --dport 22 -j ACCEPT
-A ufw-user-input -p tcp -m tcp --dport 22 -m comment --comment "\'dapp_OpenSSH\'" -j ACCEPT
-A ufw-user-input -p udp -m udp --dport 5000 -j ACCEPT
-A ufw-user-input -p udp -m multiport --dports 500,4500 -j ACCEPT
-A ufw-user-input -p tcp -m tcp --dport 3000 -j ACCEPT
-A ufw-user-limit -m limit --limit 3/min -j LOG --log-prefix "[UFW LIMIT BLOCK] "
-A ufw-user-limit -j REJECT --reject-with icmp-port-unreachable
-A ufw-user-limit-accept -j ACCEPT
COMMIT
# Completed on Fri Aug  8 14:33:27 2025
# Generated by iptables-save v1.8.10 (nf_tables) on Fri Aug  8 14:33:27 2025
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [4502:332648]
-A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE
-A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE
-A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE
-A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE
-A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE
-A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE
-A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE
-A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE
-A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE
-A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE
-A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE
-A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE
-A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE
-A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE
-A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE
-A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE
-A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE
-A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE
-A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE
-A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE
COMMIT
# Completed on Fri Aug  8 14:33:27 2025

# --- sysctl ip_forward/tcp ---
net.ipv4.ip_forward = 1
net.ipv4.ip_forward_update_priority = 1
net.ipv4.ip_forward_use_pmtu = 0

# --- crontab root ---
[crontab root недоступно]

# --- ip a ---
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host noprefixroute 
       valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 96:00:04:64:d8:5e brd ff:ff:ff:ff:ff:ff
    inet 46.62.133.47/32 metric 100 scope global dynamic eth0
       valid_lft 76710sec preferred_lft 76710sec
    inet6 2a01:4f9:c013:5d3::1/64 scope global 
       valid_lft forever preferred_lft forever
    inet6 fe80::9400:4ff:fe64:d85e/64 scope link 
       valid_lft forever preferred_lft forever
71: tun0: <POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UNKNOWN group default qlen 500
    link/none 
    inet 10.8.0.1 peer 10.8.0.2/32 scope global tun0
       valid_lft forever preferred_lft forever
    inet6 fe80::65eb:cb73:9bac:9e50/64 scope link stable-privacy 
       valid_lft forever preferred_lft forever

# --- ip r ---
default via 172.31.1.1 dev eth0 proto dhcp src 46.62.133.47 metric 100 
10.8.0.2 dev tun0 proto kernel scope link src 10.8.0.1 
172.31.1.1 dev eth0 proto dhcp scope link src 46.62.133.47 metric 100 
185.12.64.1 via 172.31.1.1 dev eth0 proto dhcp src 46.62.133.47 metric 100 
185.12.64.2 via 172.31.1.1 dev eth0 proto dhcp src 46.62.133.47 metric 100 

# --- ufw status ---
Status: active
Logging: on (low)
Default: deny (incoming), allow (outgoing), deny (routed)
New profiles: skip

To                         Action      From
--                         ------      ----
443/tcp                    ALLOW IN    Anywhere                   # HTTPS (stunnel)
5000/tcp                   ALLOW IN    Anywhere                   # Python TUN gateway
22/tcp                     ALLOW IN    Anywhere                   # SSH доступ
22/tcp (OpenSSH)           ALLOW IN    Anywhere                   # SSH по OpenSSH (альтернатива)
5000/udp                   ALLOW IN    Anywhere                   # TUN gateway UDP
500,4500/udp               ALLOW IN    Anywhere                   # IPsec VPN (strongSwan)
3000/tcp                   ALLOW IN    Anywhere                   # Grafana Web UI
443/tcp (v6)               ALLOW IN    Anywhere (v6)              # HTTPS (stunnel)
5000/tcp (v6)              ALLOW IN    Anywhere (v6)              # Python TUN gateway
22/tcp (v6)                ALLOW IN    Anywhere (v6)              # SSH доступ
22/tcp (OpenSSH (v6))      ALLOW IN    Anywhere (v6)              # SSH по OpenSSH (альтернатива)
5000/udp (v6)              ALLOW IN    Anywhere (v6)              # TUN gateway UDP
500,4500/udp (v6)          ALLOW IN    Anywhere (v6)              # IPsec VPN (strongSwan)
3000/tcp (v6)              ALLOW IN    Anywhere (v6)              # Grafana Web UI


# --- last_status ---
up

# --- socks5tun-update.service ---
[Unit]
Description=Обновление SOCKS5TUN (wheel + config)
After=network-online.target
Wants=network-online.target

[Service]
Type=oneshot
ExecStart=/usr/local/bin/update_socks5tun.sh

[Install]
WantedBy=multi-user.target
# 💡 Обновление выполняется вручную или по таймеру

# --- sshd_config ---

# This is the sshd server system-wide configuration file.  See
# sshd_config(5) for more information.

# This sshd was compiled with PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games

# The strategy used for options in the default sshd_config shipped with
# OpenSSH is to specify options with their default value where
# possible, but leave them commented.  Uncommented options override the
# default value.

Include /etc/ssh/sshd_config.d/*.conf

# When systemd socket activation is used (the default), the socket
# configuration must be re-generated after changing Port, AddressFamily, or
# ListenAddress.
#
# For changes to take effect, run:
#
#   systemctl daemon-reload
#   systemctl restart ssh.socket
#
#Port 22
#AddressFamily any
#ListenAddress 0.0.0.0
#ListenAddress ::

#HostKey /etc/ssh/ssh_host_rsa_key
#HostKey /etc/ssh/ssh_host_ecdsa_key
#HostKey /etc/ssh/ssh_host_ed25519_key

# Ciphers and keying
#RekeyLimit default none

# Logging
#SyslogFacility AUTH
#LogLevel INFO

# Authentication:

#LoginGraceTime 2m
#PermitRootLogin prohibit-password
#StrictModes yes
#MaxAuthTries 6
#MaxSessions 10

#PubkeyAuthentication yes

# Expect .ssh/authorized_keys2 to be disregarded by default in future.
#AuthorizedKeysFile	.ssh/authorized_keys .ssh/authorized_keys2

#AuthorizedPrincipalsFile none

#AuthorizedKeysCommand none
#AuthorizedKeysCommandUser nobody

# For this to work you will also need host keys in /etc/ssh/ssh_known_hosts
#HostbasedAuthentication no
# Change to yes if you don't trust ~/.ssh/known_hosts for
# HostbasedAuthentication
#IgnoreUserKnownHosts no
# Don't read the user's ~/.rhosts and ~/.shosts files
#IgnoreRhosts yes

# To disable tunneled clear text passwords, change to no here!
#PasswordAuthentication yes
#PermitEmptyPasswords no

# Change to yes to enable challenge-response passwords (beware issues with
# some PAM modules and threads)
KbdInteractiveAuthentication no

# Kerberos options
#KerberosAuthentication no
#KerberosOrLocalPasswd yes
#KerberosTicketCleanup yes
#KerberosGetAFSToken no

# GSSAPI options
#GSSAPIAuthentication no
#GSSAPICleanupCredentials yes
#GSSAPIStrictAcceptorCheck yes
#GSSAPIKeyExchange no

# Set this to 'yes' to enable PAM authentication, account processing,
# and session processing. If this is enabled, PAM authentication will
# be allowed through the KbdInteractiveAuthentication and
# PasswordAuthentication.  Depending on your PAM configuration,
# PAM authentication via KbdInteractiveAuthentication may bypass
# the setting of "PermitRootLogin prohibit-password".
# If you just want the PAM account and session checks to run without
# PAM authentication, then enable this but set PasswordAuthentication
# and KbdInteractiveAuthentication to 'no'.
UsePAM yes

#AllowAgentForwarding yes
#AllowTcpForwarding yes
#GatewayPorts no
X11Forwarding yes
#X11DisplayOffset 10
#X11UseLocalhost yes
#PermitTTY yes
PrintMotd no
#PrintLastLog yes
#TCPKeepAlive yes
#PermitUserEnvironment no
#Compression delayed
#ClientAliveInterval 0
#ClientAliveCountMax 3
#UseDNS no
#PidFile /run/sshd.pid
#MaxStartups 10:30:100
#PermitTunnel no
#ChrootDirectory none
#VersionAddendum none

# no default banner path
#Banner none

# Allow client to pass locale environment variables
AcceptEnv LANG LC_*

# override default of no subsystems
Subsystem	sftp	/usr/lib/openssh/sftp-server

# Example of overriding settings on a per-user basis
#Match User anoncvs
#	X11Forwarding no
#	AllowTcpForwarding no
#	PermitTTY no
#	ForceCommand cvs server

# --- socks5_telegram_alert.sh ---
#!/usr/bin/env bash

TOKEN="8285785110:AAGaDAsisuGlbMYDCKkAWuYl_wmgzmEsdLQ"
CHAT_ID="271161868"

MSG="🚨 *SOCKS5TUN ALERT*: \`$1\` failed on \`$(hostname)\` at \`$(date)\`"
curl -s -X POST https://api.telegram.org/bot${TOKEN}/sendMessage \
     -d chat_id=${CHAT_ID} \
     -d text="$MSG" \
     -d parse_mode=Markdown > /dev/null

# --- tmpfiles-stunnel.conf ---
d /run/stunnel 0750 stunnel stunnel -
# --- socks5tun.service ---
[Unit]
Description=SOCKS5TUN proxy server
After=network-online.target stunnel.service
Requires=stunnel.service
Wants=network-online.target
Requires=socks5tun-update.service
After=socks5tun-update.service

[Service]
Type=simple
User=root
AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE
CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE

# 💡 Только запуск! (без обновления)
ExecStart=/opt/venv-pyroute/bin/python -m socks5tun.run -c /etc/socks5tun/config_prod.json

Restart=on-failure
RestartSec=5

# ——— Защита и доступ к tun ———
NoNewPrivileges=yes
PrivateTmp=yes
ProtectSystem=full
ProtectHome=true
ProtectControlGroups=yes
PrivateDevices=no
DeviceAllow=/dev/net/tun rw
RestrictAddressFamilies=AF_INET AF_INET6 AF_NETLINK

ProtectKernelModules=yes
ProtectClock=yes
ProtectHostname=yes
ProtectProc=invisible
LockPersonality=yes
SystemCallFilter=~@mount @swap @clock @module @reboot
MountAPIVFS=yes
ReadWritePaths=/proc/sys/net/ipv4/ip_forward
MemoryDenyWriteExecute=yes

[Install]
WantedBy=multi-user.target

# --- update_socks5tun.sh ---
#!/bin/bash
set -e

PROJECT_DIR="/opt/socks5tun"
VENV_PYTHON="/opt/venv-pyroute/bin/python"
VENV_PIP="/opt/venv-pyroute/bin/pip"
CONFIG_DIR="/etc/socks5tun"
CONFIG_FILE="config_prod.json"

cd "$PROJECT_DIR" || exit 1

# 1) собираем wheel
$VENV_PYTHON -m build --wheel --outdir dist/

# 2) обновляем установленный пакет
LATEST_WHEEL=$(ls -1t dist/*.whl | head -n1)
$VENV_PIP install --upgrade "$LATEST_WHEEL"

# 3) конфиг
mkdir -p "$CONFIG_DIR"
cp -u "$PROJECT_DIR/$CONFIG_FILE" "$CONFIG_DIR/$CONFIG_FILE"

# --- init.d stunnel4 ---
#! /bin/sh -e
### BEGIN INIT INFO
# Provides:          stunnel4
# Required-Start:    $local_fs $remote_fs
# Required-Stop:     $local_fs $remote_fs
# Should-Start:      $syslog
# Should-Stop:       $syslog
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: Start or stop stunnel 4.x (TLS tunnel for network daemons)
# Description:       Starts or stops all configured TLS network tunnels. Each *.conf file in
#                    /etc/stunnel/ will spawn a separate stunnel process. The list of files
#                    can be overridden in /etc/default/stunnel, and that same file can be used
#                    to completely disable *all* tunnels.
### END INIT INFO

# Author / upstream maintainer note:
# With the planned introduction of a control interface (conceptually similar to
# apache2ctl), running separate processes for each *.conf will become obsolete.
# Please add "include = /etc/stunnel/conf.d" to stunnel.conf instead.

. /lib/lsb/init-functions

DEFAULTPIDFILE="/var/run/stunnel4.pid"
DAEMON=/usr/bin/stunnel4
NAME=stunnel
DESC="TLS tunnels"
OPTIONS=""

get_opt() {
  sed -e "s;^[[:space:]]*;;" -e "s;[[:space:]]*$;;" \
    -e "s;[[:space:]]*=[[:space:]]*;=;" "$1" |
    grep -i "^$2=" | sed -e "s;^[^=]*=;;"
}

get_pidfile() {
  local file=$1
  if [ -f $file ]; then
    CHROOT=`get_opt $file chroot`
    PIDFILE=`get_opt $file pid`
    if [ "$PIDFILE" = "" ]; then
      PIDFILE=$DEFAULTPIDFILE
    fi
    echo "$CHROOT/$PIDFILE"
  fi
}

startdaemons() {
  local res file args pidfile warn status

  if ! [ -d /var/run/stunnel4 ]; then
    rm -rf /var/run/stunnel4
    install -d -o stunnel4 -g stunnel4 /var/run/stunnel4
  fi
  if [ -n "$RLIMITS" ]; then
    ulimit $RLIMITS
  fi
  res=0
  for file in $FILES; do
    if [ -f $file ]; then
      echo -n " $file: "
      args="$file $OPTIONS"
      pidfile=`get_pidfile $file`
      if egrep -qe '^pid[[:space:]]*=' "$file"; then
        warn=''
      else
        warn=' (no pid=pidfile specified!)'
      fi
      status=0
      start_daemon -p "$pidfile" "$DAEMON" $args || status=$?
      if [ "$status" -eq 0 ]; then
        echo -n "started$warn"
      else
        echo "failed$warn"
        echo "You should check that you have specified the pid= in you configuration file"
        res=1
      fi
    fi
  done;
  echo ''
  return "$res"
}

killdaemons()
{
  local sig file pidfile status

  sig=$1
  res=0
  for file in $FILES; do
    echo -n " $file: "
    pidfile=`get_pidfile $file`
    if [ ! -e "$pidfile" ]; then
      echo -n "no pid file"
    else
      status=0
      killproc -p "$pidfile" "$DAEMON" ${sig:+"$sig"} || status=$?
      if [ "$status" -eq 0 ]; then
        echo -n 'stopped'
      else
        echo -n 'failed'
        res=1
      fi
    fi
  done
  echo ''
  return "$res"
}

querydaemons()
{
  local res file pidfile status

  res=0
  for file in $FILES; do
    echo -n " $file: "
    pidfile=`get_pidfile "$file"`
    if [ ! -e "$pidfile" ]; then
      echo -n 'no pid file'
      res=1
    else
      status=0
      pidofproc -p "$pidfile" "$DAEMON" >/dev/null || status="$?"
      if [ "$status" = 0 ]; then
        echo -n 'running'
      elif [ "$status" = 4 ]; then
        echo "cannot access the pid file $pidfile"
        res=1
      else
        echo -n 'stopped'
        res=1
      fi
    fi
  done
  echo ''
  exit "$res"
}

restartrunningdaemons()
{
  local res file pidfile status args

  res=0
  for file in $FILES; do
    echo -n " $file: "
    pidfile=`get_pidfile "$file"`
    if [ ! -e "$pidfile" ]; then
      echo -n 'no pid file'
    else
      status=0
      pidofproc -p "$pidfile" "$DAEMON" >/dev/null || status="$?"
      if [ "$status" = 0 ]; then
        echo -n 'stopping'
        killproc -p "$pidfile" "$DAEMON" "$sig" || status="$?"
        if [ "$status" -eq 0 ]; then
          echo -n ' starting'
          args="$file $OPTIONS"
          start_daemon -p "$pidfile" "$DAEMON" $args || status="$?"
          if [ "$status" -eq 0 ]; then
            echo -n ' started'
          else
            echo ' failed'
            res=1
          fi
        else
          echo -n ' failed'
          res=1
        fi
      elif [ "$status" = 4 ]; then
        echo "cannot access the pid file $pidfile"
      else
        echo -n 'stopped'
      fi
    fi
  done
  echo ''
  exit "$res"
}

if [ "x$OPTIONS" != "x" ]; then
  OPTIONS="-- $OPTIONS"
fi

[ -f /etc/default/stunnel4 ] && . /etc/default/stunnel4

# If the user want to manage a single tunnel, the conf file's name
# is in $2. Otherwise, respect /etc/default/stunnel4 setting.
# If no setting there, use /etc/stunnel/*.conf.
if [ -n "${2:-}" ]; then
  if [ -e "/etc/stunnel/$2.conf" ]; then
    FILES="/etc/stunnel/$2.conf"
  else
    echo >&2 "/etc/stunnel/$2.conf does not exist."
    exit 1
  fi
else
  if [ -z "$FILES" ]; then
    FILES="/etc/stunnel/*.conf"
  fi
fi

[ -x $DAEMON ] || exit 0

set -e

res=0
case "$1" in
  start)
    echo -n "Starting $DESC:"
    startdaemons
    res=$?
    ;;
  stop)
    echo -n "Stopping $DESC:"
    killdaemons
    res=$?
    ;;
  reopen-logs)
    echo -n "Reopening log files $DESC:"
    killdaemons USR1
    res=$?
    ;;
  force-reload|reload)
    echo -n "Reloading configuration $DESC:"
    killdaemons HUP
    res=$?
    ;;
  restart)
    echo -n "Restarting $DESC:"
    killdaemons && startdaemons
    res=$?
    ;;
  try-restart)
    echo -n "Restarting $DESC if running:"
    restartrunningdaemons
    res=$?
    ;;
  status)
    echo -n "$DESC status:"
    querydaemons
    res=$?
    ;;
  *)
    N=/etc/init.d/$NAME
    echo "Usage: $N {start|stop|status|reload|reopen-logs|restart|try-restart} [<stunnel instance>]" >&2
    res=1
    ;;
esac

exit "$res"

# --- stunnel.service (alt) ---
# /etc/systemd/system/stunnel.service
[Unit]
Description=TLS wrapper for SOCKS5TUN
After=network-online.target
Wants=network-online.target

[Service]
Type=forking
PIDFile=/run/stunnel/stunnel.pid

ExecStart=/usr/bin/stunnel /etc/stunnel/stunnel.conf
# безопасный перезапуск
ExecReload=/bin/kill -HUP $MAINPID

Restart=on-failure
RuntimeDirectory=stunnel

# ограничения
User=stunnel
Group=stunnel
AmbientCapabilities=CAP_NET_BIND_SERVICE
CapabilityBoundingSet=CAP_NET_BIND_SERVICE
NoNewPrivileges=yes
PrivateTmp=yes
ProtectSystem=strict
ProtectHome=yes

[Install]
WantedBy=multi-user.target

# --- stunnel.conf ---
# /etc/stunnel/stunnel.conf
pid = /run/stunnel/stunnel.pid
cert = /etc/stunnel/stunnel.pem

[httpsvpn]
accept = 443
connect = 127.0.0.1:5000

# --- resolv.conf ---
nameserver 127.0.0.1

# --- socks5_healthcheck.sh ---
#!/usr/bin/env bash

TOKEN="8285785110:AAGaDAsisuGlbMYDCKkAWuYl_wmgzmEsdLQ"
CHAT_ID="271161868"

STATUS_FILE="/var/lib/node_exporter/socks5tun.prom"
STATE_FILE="/var/lib/socks5health/last_status"

# Создаём папку для STATE_FILE, если не существует
mkdir -p "$(dirname "$STATE_FILE")"

# Проверка доступности через SOCKS5
if curl -sS -4 --max-time 8 --socks5-hostname 127.0.0.1:5000 https://ifconfig.co > /dev/null; then
    CURRENT="up"
    systemd-notify --status="SOCKS5 OK" --ready
    echo "socks5tun_status 1" > "$STATUS_FILE"
else
    CURRENT="down"
    systemd-notify --status="SOCKS5 ERROR"
    echo "socks5tun_status 0" > "$STATUS_FILE"
fi

# Читаем предыдущее состояние
PREV=$(cat "$STATE_FILE" 2>/dev/null || echo "unknown")

# Отправка Telegram только если статус изменился
if [[ "$CURRENT" == "up" && "$PREV" != "up" ]]; then
    curl -s -X POST https://api.telegram.org/bot${TOKEN}/sendMessage \
         -d chat_id=${CHAT_ID} \
         -d text="✅ SOCKS5TUN восстановлен на $(hostname) в $(date)" > /dev/null
elif [[ "$CURRENT" == "down" && "$PREV" != "down" ]]; then
    curl -s -X POST https://api.telegram.org/bot${TOKEN}/sendMessage \
         -d chat_id=${CHAT_ID} \
         -d text="🚨 SOCKS5TUN НЕ РАБОТАЕТ на $(hostname) в $(date)" > /dev/null
fi

# Обновляем текущее состояние
echo "$CURRENT" > "$STATE_FILE"

# Код завершения
[[ "$CURRENT" == "up" ]] && exit 0 || exit 1

# --- socks5-healthcheck.timer ---
[Unit]
Description=Run SOCKS5TUN health-probe every 5 minutes

[Timer]
OnBootSec=5min
OnUnitActiveSec=5min
Persistent=true

[Install]
WantedBy=timers.target

# --- restart-socks5tun@.service ---
[Unit]
Description=Auto-restart SOCKS5TUN when %i fails

[Service]
Type=oneshot
ExecStart=/bin/systemctl restart socks5tun


# --- /etc/stunnel/stunnel.pem (x509-dump) ---
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number:
            64:db:3b:8c:c6:e2:d2:97:85:73:1a:d2:87:c2:bd:b0:7d:ea:c9:b8
        Signature Algorithm: sha256WithRSAEncryption
        Issuer: C = RU, ST = Moscow, L = Moscow, O = private, OU = private, CN = Marat, emailAddress = shamsutdinovu@hotmail.com
        Validity
            Not Before: Jul 29 08:16:46 2025 GMT
            Not After : Jul 27 08:16:46 2035 GMT
        Subject: C = RU, ST = Moscow, L = Moscow, O = private, OU = private, CN = Marat, emailAddress = shamsutdinovu@hotmail.com
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (2048 bit)
                Modulus:
                    00:9f:b4:aa:7c:57:d9:0f:1a:2d:44:17:33:02:a7:
                    8d:4f:2c:e6:62:2c:76:d2:a6:8b:44:a1:4b:1e:6b:
                    be:51:2e:04:b7:39:00:87:88:4c:16:80:4f:78:7e:
                    05:f9:83:93:2a:71:e1:10:b0:8c:b2:8e:c3:af:b3:
                    e7:36:be:f3:52:c0:94:90:c2:f0:5d:20:10:33:f6:
                    79:10:af:4e:ff:b4:2b:5c:91:ee:d3:88:da:e6:a6:
                    5c:f6:81:c3:ec:96:37:9c:0e:76:a5:c8:fe:24:10:
                    d2:16:02:3d:88:e7:b0:82:f0:e4:b9:5e:6c:e2:e3:
                    d7:40:99:22:7d:3d:ba:ac:4b:ce:dd:40:21:1e:a0:
                    68:13:b8:9a:43:e2:ad:be:11:3f:65:5c:0c:38:ce:
                    da:6b:7e:4a:04:dd:d7:dc:c4:c5:81:8b:d2:e7:26:
                    36:36:3e:6e:6d:66:e5:55:98:f0:07:aa:28:95:c7:
                    ac:26:83:cc:f0:0b:3d:8a:45:79:af:8b:8e:3a:cc:
                    7c:87:06:7d:19:17:28:24:ba:c0:a8:59:e1:de:b9:
                    37:fc:11:99:6d:1d:3b:e6:0e:4b:08:63:b1:85:fc:
                    f9:99:4a:0c:4c:42:c5:f8:e8:cf:a1:36:de:b5:88:
                    10:f7:cd:1b:a6:60:83:bc:bf:12:5d:e7:7b:ab:09:
                    cb:55
                Exponent: 65537 (0x10001)
        X509v3 extensions:
            X509v3 Subject Key Identifier: 
                52:C9:59:DB:27:27:29:78:9C:B0:27:93:6F:28:D5:CC:AA:2F:1C:87
            X509v3 Authority Key Identifier: 
                52:C9:59:DB:27:27:29:78:9C:B0:27:93:6F:28:D5:CC:AA:2F:1C:87
            X509v3 Basic Constraints: critical
                CA:TRUE
    Signature Algorithm: sha256WithRSAEncryption
    Signature Value:
        70:b6:b3:c4:35:01:6b:ae:c4:87:d5:25:4e:76:97:4e:8b:a4:
        d9:35:95:98:19:0c:f6:d3:11:ca:83:e8:86:2d:fe:95:52:e5:
        c9:a0:08:27:33:82:b2:14:3f:08:9b:0d:2a:ba:0b:8f:15:5b:
        eb:96:69:1e:6f:f5:56:0e:38:a4:dc:f1:f0:a5:df:fa:07:2a:
        15:7a:b5:71:36:15:a5:f0:97:d7:55:dd:d2:ec:5e:2d:93:67:
        b2:80:49:d3:89:6e:e6:10:c5:d2:25:49:c4:02:d6:80:e5:eb:
        37:8d:70:75:80:dd:93:73:29:64:a1:a8:bd:de:f1:55:56:07:
        f9:82:be:71:41:fe:07:14:7c:5d:26:dd:d3:92:0f:11:2c:98:
        4e:99:85:d2:f5:ad:55:44:12:2f:63:28:fc:79:11:ae:9c:c0:
        23:1f:c3:74:7f:c8:b9:d8:e6:f8:dd:31:79:86:a7:ee:18:fb:
        1c:27:73:83:db:d3:13:23:5a:c6:09:0b:15:0e:39:aa:73:76:
        74:43:13:f1:77:e9:67:1e:05:d3:1f:66:05:1b:76:02:d7:b1:
        51:64:cd:33:28:ee:fe:b1:3e:c0:6a:01:bf:ac:87:56:b6:3f:
        0a:19:cc:19:eb:ce:1c:85:6d:6d:0d:5e:91:25:e4:64:5b:d6:
        e2:e3:b8:03
